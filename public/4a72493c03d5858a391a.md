---
title: GitBucket の Markdown レンダリングを強化する試み
tags:
  - Scala
  - GitBucket
private: false
updated_at: '2025-08-02T17:00:51+09:00'
id: 4a72493c03d5858a391a
organization_url_name: null
slide: false
ignorePublish: false
---

## 概要

[GitBucket](https://gitbucket.github.io/) は、[GitHub](https://github.com/) のようにネットワーク上で [Git](https://git-scm.com/) リポジトリを共有できる Web サービスです。

- Apache-2.0 ライセンスで配布されている。
- [Scala](https://scala-lang.org/) で開発されており、Java 17 実行環境があれば、起動可能。
- お試しであれば、内臓の[H2データベースエンジン](https://www.h2database.com/html/main.html)が利用できる。
  - 実運用には、[PostgreSQL](https://www.h2database.com/html/main.html) や　[MariaDB](https://mariadb.org/) などのリレーショナルデータベースサーバーの利用を推奨
- 非常に簡単にセルフホストが可能です。

今回は、GitBucket 標準のマークダウンレンダリング機能を置き換える試みです。

成果を [yasumichi/gitbucket-markdown-enhanced: GitBucket Markdown Enhanced Plugin](https://github.com/yasumichi/gitbucket-markdown-enhanced) に公開しています。

Scala の利用経験が浅いので色々、ご教示いただけますと幸いです。

## これまでの GitBucket プラグインへの関わり

[gitbucket-drawio-plugin](https://github.com/onukura/gitbucket-drawio-plugin) を導入しましたが、4年開発が止まっているせいか、うまく動作しなかったので改修しました。

- [gitbucket-drawio-plugin を動くようにしたい](https://zenn.dev/yasumichi/articles/04d09995388959)
- [gitbucket-drawio-plugin からセルフホストの draw.io にアクセスさせたい](https://zenn.dev/yasumichi/articles/87cf2e9ab60aa5)

## 目標は Visual Studio Code の Markdown Preview Enhanced

目標は、[Visual Studio Code](https://code.visualstudio.com/) の [Markdown Preview Enhanced](https://shd101wyy.github.io/markdown-preview-enhanced/#/) 向けの markdown ファイルを軽易に Web で共有できる環境です。

実現できない機能もあるかと思いますが、できるだけ、近づけたいと考えます。

## 本家の gitbucket.core.view.Markdown の拡張を考えたが挫折

本家の [gitbucket/src/main/scala/gitbucket/core/view/Markdown.scala](https://github.com/gitbucket/gitbucket/blob/14d7e9ee90b2444da6ba95306223c8e1e0a0a9b1/src/main/scala/gitbucket/core/view/Markdown.scala) を派生して強化するか、このクラスが利用している [markedj](https://github.com/gitbucket/markedj) を直接修正するか考えましたが、挫折しました。

## flexmark-java との出会い

大してリサーチした訳ではないですが、Java の markdown ライブラリを探していた際に最近の commit もあって拡張機能が豊富な [flexmark-java](https://github.com/vsch/flexmark-java/) を見つけました。

flexmark-java を Scala から利用するためには、build.sbt に以下の行を加えます。

```scala
libraryDependencies += "com.vladsch.flexmark" % "flexmark-all" % "0.64.8"
```

## gitbucket.core.plugin.Renderer の拡張

Renderer を開発するには、gitbucket.core.plugin.Renderer から派生したクラスで render メソッドをオーバーライドします。

素の flexmark-java を使う場合は、以下のようになります。

```scala
class MarkdownEnhancedRenderer extends Renderer {
  def render(request: RenderRequest): Html = {
    import request._
    Html(toHtml(fileContent)(context))
  }

  def shutdown(): Unit = {
  }

  def toHtml(content: String)(implicit context: Context): String = {
    val options = new MutableDataSet();
    
    val parser = Parser.builder(options).build()
    val renderer = HtmlRenderer.builder(options).build()

    val document = parser.parse(content)
    renderer.render(document)
  }
}
```

## gitbucket.core.plugin.Plugin の拡張

gitbucket.core.plugin.Plugin を継承し、前項で作成した renderer を initialize メソッドで登録します。

```scala
class Plugin extends gitbucket.core.plugin.Plugin {
  override val pluginId: String = "gitbucket-markdown-enhanced"
  override val pluginName: String = "GitBucket Markdown Enhanced Plugin"
  override val description: String = "Rendering markdown files."
  override val versions: List[Version] = List(
    new Version("0.1.0")
  )

  private[this] var renderer: Option[MarkdownEnhancedRenderer] = None

  override def initialize(registry: PluginRegistry, context: ServletContext, settings: SystemSettingsService.SystemSettings): Unit = {
    val test = Try{ new MarkdownEnhancedRenderer() }
    val mer = test.get
    registry.addRenderer("md", mer)
    renderer = Option(mer)
    super.initialize(registry, context, settings)
  }

  override def shutdown(registry: PluginRegistry, context: ServletContext, settings: SystemSettings): Unit = {
    renderer.foreach(r => r.shutdown())
  }

}
```

## flexmark-java の拡張機能を利用

拡張機能のコレクションを生成し、オプション `Parser.EXTENSIONS` にセットします。

```scala
    val extension: Seq[Extension] = Seq(
      AnchorLinkExtension.create(),
      EmojiExtension.create(),
      FootnoteExtension.create(),
      GitLabExtension.create(),
      StrikethroughExtension.create(),
      TablesExtension.create(),
      TaskListExtension.create(),
      TocExtension.create()
    )
   options.set(Parser.EXTENSIONS, extension.asJava)
```

この際、Scala のコレクションを Java のコレクションに変換する `asJava` メソッドを使用するため、以下の import 文を追加する必要がありました。

```scala
import collection.JavaConverters._
```

### AnchorLinkExtension

https://github.com/vsch/flexmark-java/wiki/Extensions#anchorlink

タイトルアンカーをリンクにする機能です。

GitBucket 本家とリンクの表示が異なるので同じようにできないか、調査中です。

### EmojiExtension

https://github.com/vsch/flexmark-java/wiki/Extensions#emoji

有効にしたものまだ絵文字のレンダリングに成功しておらず、使用方法を調査中です… :sweat:

### FootnoteExtension

https://github.com/vsch/flexmark-java/wiki/Extensions#footnotes

脚注を有効にする拡張機能です。

### GitLabExtension

https://github.com/vsch/flexmark-java/wiki/Extensions#gitlab-flavoured-markdown

[GitLab Flavoured Markdown](https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/doc/user/markdown.md) を利用できるようにする拡張機能です。

特に以下の機能サポートを利用できるようになります。

- 数式を描画する [katex](https://katex.org/)
- ダイアグラムを描画する [mermaid](https://mermaid.js.org/)

ただし、これらを利用する場合、以下の CSS と JavaScript の追加が必要です。

```html
<link rel="stylesheet" href="katex.min.css">
<script src="katex.min.js"></script>
<script src="mermaid.min.js"></script>
<script>
    (function () {
      document.addEventListener("DOMContentLoaded", function () {
        var mathElems = document.getElementsByClassName("katex");
        var elems = [];
        for (const i in mathElems) {
            if (mathElems.hasOwnProperty(i)) elems.push(mathElems[i]);
        }

        elems.forEach(elem => {
            katex.render(elem.textContent, elem, { throwOnError: false, displayMode: elem.nodeName !== 'SPAN', });
        });
    });
})();
```

これを出力するため、 gitbucket.core.plugin.Plugin の javaScripts メソッドをオーバーライドします。

```scala
  override def javaScripts(registry: PluginRegistry, context: ServletContext, settings: SystemSettingsService.SystemSettings): Seq[(String, String)] = {
    val jsPath = settings.baseUrl.getOrElse(context.getContextPath) + "/plugin-assets/gme"
    Seq(".*" -> s"""
      |</script>
      |<link rel='stylesheet' href='$jsPath/katex.min.css'>
      |<script src="${jsPath}/katex.min.js">
      |</script>
      |<script src="${jsPath}/mermaid.min.js">
      |(function () {
      |  document.addEventListener("DOMContentLoaded", function () {
      |    var mathElems = document.getElementsByClassName("katex");
      |    var elems = [];
      |    for (const i in mathElems) {
      |      if (mathElems.hasOwnProperty(i)) elems.push(mathElems[i]);
      |    }
      |    elems.forEach(elem => {
      |      katex.render(elem.textContent, elem, { throwOnError: false, displayMode: elem.nodeName !== 'SPAN', });
      |    });
      |  });
      |})();
      |""".stripMargin)
  }
```

### StrikethroughExtension

https://github.com/vsch/flexmark-java/wiki/Extensions#gfm-strikethroughsubscript

打消し線を有効にする拡張機能です。

### TablesExtension

https://github.com/vsch/flexmark-java/wiki/Extensions#tables

表の出力を制御する拡張機能です。

### TaskListExtension

https://github.com/vsch/flexmark-java/wiki/Extensions#gfm-tasklist

GitBucket 本家の機能でも実現されていますが、GitHub 風のタスクリストを扱うための拡張機能です。

### TocExtension

https://github.com/vsch/flexmark-java/wiki/Extensions#table-of-contents

目次(Table of contents) を出力できる拡張です。

```markdown
[TOC]
```

上記の記述がある部分を目次に変換します。 `levels` でどの階層までを目次に出力するか、制御できます。

## 参考文献

- [vsch/flexmark-java: CommonMark/Markdown Java parser with source level AST. CommonMark 0.28, emulation of: pegdown, kramdown, markdown.pl, MultiMarkdown. With HTML to MD, MD to PDF, MD to DOCX conversion modules.](https://github.com/vsch/flexmark-java)
  - [Extensions · vsch/flexmark-java Wiki](https://github.com/vsch/flexmark-java/wiki/Extensions)
- [新Markdown導入の背景とその実装について | 株式会社ヌーラボ(Nulab inc.)](https://nulab.com/ja/blog/nulab/new-markdown-implementation-background/#flexmark-java%E3%81%A7Markdown%E3%83%91%E3%83%BC%E3%82%B5%E3%83%BC%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B)
- [flexmark-java で Markdown を HTML に変換する #Java - Qiita](https://qiita.com/niwasawa/items/5595c2fdbfb943c4cb96)
- [Java と Scala 間のコレクションの変換 | Collections | Scala Documentation](https://docs.scala-lang.org/ja/overviews/collections/conversions-between-java-and-scala-collections.html)
- [sbt Reference Manual — ライブラリ依存性](https://www.scala-sbt.org/1.x/docs/ja/Library-Dependencies.html)
