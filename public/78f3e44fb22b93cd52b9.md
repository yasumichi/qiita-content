---
title: GitBucket Markdown Enhanced Plugin に WaveDrom サポートを追加しました
tags:
  - Scala
  - GitBucket
  - WaveDrom
private: false
updated_at: '2025-12-07T17:46:00+09:00'
id: 78f3e44fb22b93cd52b9
organization_url_name: null
slide: false
ignorePublish: false
---
## 概要

[GitBucket](https://gitbucket.github.io/)用のプラグイン [GitBucket Markdown Enhanced Plugin](https://github.com/yasumichi/gitbucket-markdown-enhanced)を開発しています。

今回は、[Visual Studio Code](https://code.visualstudio.com/) のプラグイン [Markdown Preview Enhanced](https://shd101wyy.github.io/markdown-preview-enhanced/#/)がサポートしている [WaveDrom](https://wavedrom.com/) のサポートを追加しました。

## 前回の記事

https://qiita.com/yasumichi/items/7e3845aa96733d41627b

## 必要なスクリプトを同梱

[src\main\resources\gme\assets\wavedrom](https://github.com/yasumichi/gitbucket-markdown-enhanced/tree/0.5.0/src/main/resources/gme/assets/wavedrom) ディレクトリを作成し、`default.js` と `wavedrom.min.js` を同梱しました。

## 必要なスクリプトを読み込む修正

[src\main\scala\Plugin.scala](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/0.5.0/src/main/scala/Plugin.scala) の `javaScripts` メソッドを修正しました。

```diff
diff --git a/src/main/scala/Plugin.scala b/src/main/scala/Plugin.scala
index a221329..f29afc7 100644
--- a/src/main/scala/Plugin.scala
+++ b/src/main/scala/Plugin.scala
@@ -88,13 +88,17 @@ class Plugin extends gitbucket.core.plugin.Plugin {
       |<link rel='stylesheet' href='$jsPath/admonition.css'>
       |<link rel='stylesheet' href='$jsPath/katex.min.css'>
       |<link rel='stylesheet' href='$jsPath/gme.css'>
-      |<script src="${jsPath}/admonition.js">
+      |<script src="${jsPath}/admonition.js" type="text/javascript">
       |</script>
-      |<script src="${jsPath}/katex.min.js">
+      |<script src="${jsPath}/katex.min.js" type="text/javascript">
       |</script>
-      |<script src="${jsPath}/mermaid.min.js">
+      |<script src="${jsPath}/mermaid.min.js" type="text/javascript">
       |</script>
-      |<script src="${jsPath}/gme.js">
+      |<script src="${jsPath}/wavedrom/default.js" type="text/javascript">
+      |</script>
+      |<script src="${jsPath}/wavedrom/wavedrom.min.js" type="text/javascript">
+      |</script>
+      |<script src="${jsPath}/gme.js" type="text/javascript">
       |""".stripMargin)
   }
```

関係ない修正が入ってしまいましたが、肝となるのは次の行です。

```scala
      |<script src="${jsPath}/wavedrom/default.js" type="text/javascript">
      |</script>
      |<script src="${jsPath}/wavedrom/wavedrom.min.js" type="text/javascript">
      |</script>
```

## WaveDrom のコードブロックを生成できるように既存の処理を修正

[src\main\scala\io\github\yasumichi\gme\MarkdownEnhancedNodeRenderer.scala](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/d9ca0783a7f1ad6bb406dd4ec1f3d88d79d922b7/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedNodeRenderer.scala) の `renderFencedCodeBlock` メソッド(旧名 `render` メソッド) を修正し、新しく作成した `renderWaveDrom` メソッドを呼び出すようにしました。

修正後の `renderFencedCodeBlock` メソッドは、次のコードになりました。

```scala
  private def renderFencedCodeBlock(
      node: FencedCodeBlock,
      context: NodeRendererContext,
      html: HtmlWriter
  ): Unit = {
    val htmlOptions: HtmlRendererOptions = context.getHtmlOptions()
    val language: BasedSequence =
      node.getInfoDelimitedByAny(htmlOptions.languageDelimiterSet)

    if (language.equals("plantuml")) {
      renderPlantUML(html, node)
    } else if (language.equals("wavedrom")) {
      renderWaveDrom(html, node)
    } else {
      context.delegateRender()
    }
  }
```

上記で呼び出される `renderWaveDrom` メソッドは、次のコードです。

```scala
  private def renderWaveDrom(html: HtmlWriter, node: FencedCodeBlock): Unit = {
    var text = ""
    var seqs = node.getContentLines().toArray()
    for (i <- 0 to seqs.length - 1) text = text + seqs(i).toString()

    logger.info(text)
    html
      .withAttr()
      .attr("type", "WaveDrom")
      .tag("script")
    html.append(text)
    html.tag("/script")
  }
```

この段階で以下のようなマークダウンを書くと HTML への変換時に `<script>` ブロックが生成されるようになりました。

<pre>
```wavedrom
{ signal : [
  { name: "clk",  wave: "p......" },
  { name: "bus",  wave: "x.34.5x",   data: "head body tail" },
  { name: "wire", wave: "0.1..0." },
]}
```
</pre>

↓

```html
<script type="WaveDrom" id="InputJSON_0">{ signal : [
{ name: "clk",  wave: "p......" },
{ name: "bus",  wave: "x.34.5x",   data: "head body tail" },
{ name: "wire", wave: "0.1..0." },
]}
</script>
```

## WaveDrom.ProcessAll() を実行しても図形が描画されない…

この段階で開発者ツールを使用して、`WaveDrom.ProcessAll()` を実行しましたが、以下のようなエラーメッセージが表示され、図形を描画することができませんでした。

```
Uncaught TypeError: points.item(...).type.toLowerCase is not a function
    exports https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js:2
    onload 省略
wavedrom.min.js:2:17034
    exports https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js:2
    onload 省略
```

調査したところ、SVG 要素が混在している場合に当該エラーが発生することが分かりました。

WaveDrom の [lib\process-all.js](https://github.com/wavedrom/wavedrom/blob/9c3aea88c75122479424b57c5be84b83dcb397ec/lib/process-all.js) を以下のように修正して、ビルドしたバージョンを使用することにしました。

```diff
diff --git a/lib/process-all.js b/lib/process-all.js
index 912847f..0f90c39 100644
--- a/lib/process-all.js
+++ b/lib/process-all.js
@@ -9,7 +9,7 @@ function processAll () {
     let index = 0; // actual number of valid anchor
     const points = document.querySelectorAll('*');
     for (let i = 0; i < points.length; i++) {
-        if (points.item(i).type && points.item(i).type.toLowerCase() === 'wavedrom') {
+        if (points.item(i).type && typeof(points.item(i).type) == "string" && points.item(i).type.toLowerCase() === 'wavedrom') {
             points.item(i).setAttribute('id', 'InputJSON_' + index);

             const node0 = document.createElement('div');
```

問題になったノードを調べたところ、type プロパティが文字列ではなく `SVGAnimatedEnumeration { baseVal: 1, animVal: 1 }` になっていたため、上記のように修正しました。

本件、本家に issue と Pull Request を送りました。

[WaveDrom.ProcessAll() fails when SVG elements are mixed. · Issue #442 · wavedrom/wavedrom](https://github.com/wavedrom/wavedrom/issues/442)

[Excludes SVG elements by yasumichi · Pull Request #441 · wavedrom/wavedrom](https://github.com/wavedrom/wavedrom/pull/441)

Reject されないと良いのですが…

## WaveDrom.ProcessAll() を自動で呼ぶように修正

[src\main\resources\gme\assets\gme.js](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/0.5.0/src/main/resources/gme/assets/gme.js) を修正しました。

以下、抜粋です。

```js
    document.addEventListener("DOMContentLoaded", function(){
        var preview = document.querySelector("#preview");
        if (preview) {
            const config = { attributes: false, childList: true, subtree: false };

            const observer = new MutationObserver((mutations) => {
                mutations.forEach(async (mutation) => {
                    if (mutation.addedNodes.length == 1) {
                        observer.disconnect();
                        renderKatex();
                        await mermaid.run();
                        WaveDrom.ProcessAll();
                        observer.observe(preview, config);
                    }
                });
            });

            observer.observe(preview, config);
        }
        renderKatex();
        WaveDrom.ProcessAll();
    });
```

## 以上で GitBucket で WaveDrom の図が表示できるようになりました。

スクリーンショットを貼ります。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/2a5ec9a4-3dc6-4485-be29-e92164b99556.png)
