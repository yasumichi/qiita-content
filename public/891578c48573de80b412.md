---
title: GitBucket Markdown Enhanced Plugin でリンクの解決を見直しました
tags:
  - Scala
  - GitBucket
private: false
updated_at: '2025-12-27T13:45:45+09:00'
id: 891578c48573de80b412
organization_url_name: null
slide: false
ignorePublish: false
---
## 概要

[GitBucket](https://gitbucket.github.io/)用のプラグイン [GitBucket Markdown Enhanced Plugin](https://github.com/yasumichi/gitbucket-markdown-enhanced)を開発しています。

GitBucket Markdown Enhanced Plugin は、GitBucket 標準のマークダウンレンダリングエンジンを置き換えるプラグインです。

目標は、[Visual Studio Code](https://code.visualstudio.com/) の [Markdown Preview Enhanced](https://shd101wyy.github.io/markdown-preview-enhanced/#/) 向けの markdown ファイルを軽易に Web で共有できる環境です。

これまで相対リンクによる画像の埋め込みやリンクの処理がイマイチだったのですが、全般的に見直しました。(ただし、ディレクトリへのリンクが解決出来ていません…)

## 前回の記事

https://qiita.com/yasumichi/items/a24742d5a129732fb0ea

## リンクを解決する MarkdownEnhancedLinkResolver の修正履歴

[History for src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedLinkResolver.scala - yasumichi/gitbucket-markdown-enhanced](https://github.com/yasumichi/gitbucket-markdown-enhanced/commits/main/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedLinkResolver.scala)

かなり迷走しています。

## AI がそれっぽいコードをサジェストしてきたのを検証なく入れてた

[fix link on preview and image url · yasumichi/gitbucket-markdown-enhanced@5e80992](https://github.com/yasumichi/gitbucket-markdown-enhanced/commit/5e80992ae2f202bc16d09971b60b82df36d42e97)

上記コミットには、一部、AI によりサジェストされたコードが入っています。なんとなくそれっぽく見えたのであまり修正せず、コミットしてしまいました。

## 全般的な見直しを行ったコミット

[Overall review of relative URL handling · yasumichi/gitbucket-markdown-enhanced@d5198b1](https://github.com/yasumichi/gitbucket-markdown-enhanced/commit/d5198b12a4915679bbb90d08b32332434c4f0a79)

AI によるコードを排除し、`java.net.URI` クラスの `resolve` メソッドで相対リンクを解決するように修正しました。

## ユーザーは想定しないパスを入力するもの

`java.net.URI` クラスを導入したことで `java.net.URI` が正しいと認識しないパスが入力されると例外が発生してしまいます。

職場であったのは、Windows の共有フォルダのパスをリンク記法で埋め込むというものでした。さらに、円マーク(バックスラッシュ)がエスケープシーケンスで食われてしまうことを嫌って `[アンカー]("共有フォルダのパス")` のようにダブルクォーテーションで囲まれていました。

ちゃんと例外処理しないとダメですね…

## バックスラッシュがあったら、相対リンクとして処理しないように修正

[Changed to ignore URLs that start with a backslash · yasumichi/gitbucket-markdown-enhanced@803b42c](https://github.com/yasumichi/gitbucket-markdown-enhanced/commit/803b42cdbc0f0e3506fc9cfa81b76d99022b27c1)

## 例外処理を行ったコミット

[Handled java.net.URI exceptions. · yasumichi/gitbucket-markdown-enhanced@65677bb](https://github.com/yasumichi/gitbucket-markdown-enhanced/commit/65677bb310fbca63f4181f8631dab7d0956febc5)

## まだまだ問題はありそう

- 相対リンクでファイルではなくディレクトリを指定されると 404 Not Found なリンクになる
- セキュリティ的な考慮は足りない
- [Java の標準 URI ライブラリが RFC 3986 に対応していないので、自作ライブラリで対応する羽目になった話 #Web - Qiita](https://qiita.com/hidebike712/items/2dd37ebe13e63679f0a5) みたいな話もあるので将来的には実装変更が必要かも

最近、新たな GitBucket プラグインである [GitBucket Flexible Gantt Plugin](https://github.com/yasumichi/gitbucket-flexible-gantt-plugin) を開発して、GitBucket のコアサービスから、情報を取得する方法を覚えたのでフィードバックできればと考えています。

## 参考リンク

- [文字列 | Collections | Scala Documentation](https://docs.scala-lang.org/ja/overviews/collections/strings.html)
- [配列(リスト)の一部を配列として取り出すには (subList / slice / array_slice) | hydroculのメモ](https://hydrocul.github.io/wiki/programming_languages_diff/list/sub-list.html)
- [配列(リスト)から先頭のn個を除く残りを配列で取得するには | hydroculのメモ](https://hydrocul.github.io/wiki/programming_languages_diff/list/drop.html)
- [Java の標準 URI ライブラリが RFC 3986 に対応していないので、自作ライブラリで対応する羽目になった話 #Web - Qiita](https://qiita.com/hidebike712/items/2dd37ebe13e63679f0a5)
