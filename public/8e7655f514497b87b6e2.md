---
title: GitBucket Markdown Enhanced Plugin に PlantUML サポートを組み込む
tags:
  - Scala
  - PlantUML
  - GitBucket
  - flexmark-java
private: false
updated_at: '2025-08-14T15:10:39+09:00'
id: 8e7655f514497b87b6e2
organization_url_name: null
slide: false
ignorePublish: false
---
## 概要

[GitHub](https://github.com/) のようにネットワーク上で [Git](https://git-scm.com/) リポジトリを共有できる Web サービス [GitBucket](https://gitbucket.github.io/)用のプラグイン [GitBucket Markdown Enhanced Plugin](https://github.com/yasumichi/gitbucket-markdown-enhanced)を開発していきます。

GitBucket Markdown Enhanced Plugin は、GitBucket 標準のマークダウンレンダリングエンジンを置き換えるプラグインです。

目標は、[Visual Studio Code](https://code.visualstudio.com/) の [Markdown Preview Enhanced](https://shd101wyy.github.io/markdown-preview-enhanced/#/) 向けの markdown ファイルを軽易に Web で共有できる環境です。

実現できない機能もあるかと思いますが、できるだけ、近づけたいと考えます。

今回は、コードブロックでの PlantUML サポートを組み込みたいと思います。

## 前回の記事

https://qiita.com/yasumichi/items/f33924ef28babf969cb0

## PlantUML のライブラリを組み込む

[build.sbt](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/104603fc4f89f5db26c8ea588ef18904b92e0917/build.sbt) に以下の行を追加し、PlantUML を依存ライブラリに追加します。

```scala
libraryDependencies += "net.sourceforge.plantuml" % "plantuml" % "8059"
```

## NodeRenderer を継承し独自のレンダラークラスを作成

[com.vladsch.flexmark.html.renderer.NodeRenderer](https://github.com/vsch/flexmark-java/blob/master/flexmark/src/main/java/com/vladsch/flexmark/html/renderer/NodeRenderer.java)を継承し、独自のレンダラークラス [MarkdownEnhancedNodeRenderer](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/104603fc4f89f5db26c8ea588ef18904b92e0917/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedNodeRenderer.scala) を作成します。

```scala
package io.github.yasumichi.gme

import com.vladsch.flexmark.ast.FencedCodeBlock
import com.vladsch.flexmark.html.HtmlRendererOptions
import com.vladsch.flexmark.html.HtmlWriter
import com.vladsch.flexmark.html.renderer.{NodeRenderer, NodeRendererContext, NodeRendererFactory, NodeRenderingHandler}
import com.vladsch.flexmark.util.data.DataHolder
import com.vladsch.flexmark.util.sequence.BasedSequence

import net.sourceforge.plantuml.FileFormat
import net.sourceforge.plantuml.FileFormatOption
import net.sourceforge.plantuml.SourceStringReader

import java.io.ByteArrayOutputStream
import java.io.IOException
import java.util
import java.nio.charset.Charset

class MarkdownEnhancedNodeRenderer extends NodeRenderer {

  override def getNodeRenderingHandlers(): util.Set[NodeRenderingHandler[_ <: Object]] = {
    val set: util.HashSet[NodeRenderingHandler[_]] = new util.HashSet[NodeRenderingHandler[_]]
    set.add(new NodeRenderingHandler[FencedCodeBlock](classOf[FencedCodeBlock], this.render))
    set
  }

  private def render(node: FencedCodeBlock, context: NodeRendererContext, html: HtmlWriter): Unit = {
    val htmlOptions:HtmlRendererOptions  = context.getHtmlOptions()
    val language:BasedSequence  = node.getInfoDelimitedByAny(htmlOptions.languageDelimiterSet)

    if (language.equals("plantuml")) {
        var text = ""
        var seqs = node.getContentLines().toArray()
        for(i <- 0 to seqs.length - 1) text = text + seqs(i).toString + "\n"

      val reader = new SourceStringReader(text)
      val os = new ByteArrayOutputStream()
      reader.generateImage(os, new FileFormatOption(FileFormat.SVG))
      
      html.tag("div")
      html.append(new String(os.toByteArray(), Charset.forName("UTF-8")))
      html.tag("/div") 
      os.close()

    } else {
        context.delegateRender()
    }
  }
}

object MarkdownEnhancedNodeRenderer {
  class Factory() extends NodeRendererFactory {
    override def apply(options: DataHolder): NodeRenderer = new MarkdownEnhancedNodeRenderer()
  }
}
```

`getNodeRenderingHandlers()` でノードの種類に応じた `render` メソッドの集合を返します。今回は、バッククォート3つで囲まれた [FencedCodeBlock](https://github.com/vsch/flexmark-java/blob/master/flexmark/src/main/java/com/vladsch/flexmark/ast/FencedCodeBlock.java) を処理の対象とします。

登録した `render` メソッドでは、まず、以下のコードにより、コードブロックに付記された言語を取得します。

```scala
    val language:BasedSequence  = node.getInfoDelimitedByAny(htmlOptions.languageDelimiterSet)
```

取得した言語が `plantuml` であれば、自前で処理し、そうでなければ、他の Render に処理を委譲します。

自前での処理は以下の部分です。

```scala
      var text = ""
      var seqs = node.getContentLines().toArray()
      for (i <- 0 to seqs.length - 1) text = text + seqs(i).toString + "\n"

      val reader = new SourceStringReader(text)
      val os = new ByteArrayOutputStream()
      reader.generateImage(os, new FileFormatOption(FileFormat.SVG))

      html.tag("div")
      html.append(new String(os.toByteArray(), Charset.forName("UTF-8")))
      html.tag("/div")
      os.close()
```

あまり、Scala 的な書き方になっていないかつ乱暴な気もしますが… :sweat:

## ParserExtension を HtmlRendererExtension とともに継承し独自の拡張機能を作成

[ParserExtension](https://github.com/vsch/flexmark-java/blob/bcfe84a3ab6d23d04adce3e5a0bae45c6b791d14/flexmark/src/main/java/com/vladsch/flexmark/parser/Parser.java#L604) を [HtmlRendererExtension](https://github.com/vsch/flexmark-java/blob/bcfe84a3ab6d23d04adce3e5a0bae45c6b791d14/flexmark/src/main/java/com/vladsch/flexmark/html/HtmlRenderer.java#L476) とともに継承し独自の拡張機能 [MarkdownEnhancedExtention](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/104603fc4f89f5db26c8ea588ef18904b92e0917/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedExtention.scala) を作成します。

```scala
package io.github.yasumichi.gme

import com.vladsch.flexmark.html.HtmlRenderer
import com.vladsch.flexmark.html.HtmlRenderer.HtmlRendererExtension
import com.vladsch.flexmark.parser.Parser
import com.vladsch.flexmark.parser.Parser.ParserExtension
import com.vladsch.flexmark.util.data.MutableDataHolder

class MarkdownEnhancedExtention extends ParserExtension with HtmlRendererExtension {

    override def extend(parserBuilder: Parser.Builder): Unit = {}

    override def parserOptions(options: MutableDataHolder): Unit = {}

    override def rendererOptions(options: MutableDataHolder): Unit = {}

    override def extend(htmlRendererBuilder: HtmlRenderer.Builder, rendererType: String): Unit =
        htmlRendererBuilder.nodeRendererFactory((new MarkdownEnhancedNodeRenderer.Factory()))
}

object MarkdownEnhancedExtention {
  def create(): MarkdownEnhancedExtention = new MarkdownEnhancedExtention()
}
```

## 既存の MarkdownEnhancedRenderer で上記拡張機能を有効にする

[gitbucket-markdown-enhanced/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedRenderer.scala の47行名](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/104603fc4f89f5db26c8ea588ef18904b92e0917/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedRenderer.scala#L47)に以下のコードを追加します。

```scala
      MarkdownEnhancedExtention.create()
```

## とりあえず plantuml コードブロックを SVG に変換できました

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/a9431b33-98b4-4e59-aa48-782569ad60ac.png)

## 参考文献

- [新Markdown導入の背景とその実装について | 株式会社ヌーラボ(Nulab inc.)](https://nulab.com/ja/blog/nulab/new-markdown-implementation-background/#flexmark-java%E3%81%A7Markdown%E3%83%91%E3%83%BC%E3%82%B5%E3%83%BC%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B)
- [PlantUMLをJavaから呼び出す](https://plantuml.com/ja/api)
- [flexmark-java/flexmark-ext-gitlab/src/main/java/com/vladsch/flexmark/ext/gitlab/internal/GitLabNodeRenderer.java at master · vsch/flexmark-java](https://github.com/vsch/flexmark-java/blob/master/flexmark-ext-gitlab/src/main/java/com/vladsch/flexmark/ext/gitlab/internal/GitLabNodeRenderer.java)
