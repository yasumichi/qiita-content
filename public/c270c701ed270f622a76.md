---
title: >-
  GitBucket Markdown Enhanced Plugin で KaTeX の記法を Markdown Preview Enhanced
  に合わせました
tags:
  - Scala
  - Markdown
  - GitBucket
  - KaTeX
private: false
updated_at: '2025-12-27T12:22:39+09:00'
id: c270c701ed270f622a76
organization_url_name: null
slide: false
ignorePublish: false
---
## 概要

[GitBucket](https://gitbucket.github.io/)用のプラグイン [GitBucket Markdown Enhanced Plugin](https://github.com/yasumichi/gitbucket-markdown-enhanced)を開発しています。

GitBucket Markdown Enhanced Plugin は、GitBucket 標準のマークダウンレンダリングエンジンを置き換えるプラグインです。

目標は、[Visual Studio Code](https://code.visualstudio.com/) の [Markdown Preview Enhanced](https://shd101wyy.github.io/markdown-preview-enhanced/#/) 向けの markdown ファイルを軽易に Web で共有できる環境です。

これまで数式の描画は、[flexmark-java](https://github.com/vsch/flexmark-java) の [GitLab Flavoured Markdown](https://github.com/vsch/flexmark-java/wiki/Extensions#gitlab-flavoured-markdown) という拡張機能により、実現していました。

ところが、この拡張機能の記法は、Markdown Preview Enhanced が採用している記法と異なっていました。今回は、これまでの記法に加え、Markdown Preview Enhanced が採用している記法に対応した際の記録です。

## 前回の記事

https://qiita.com/yasumichi/items/e55b27dd07f9d41821af

## GitLab Flavoured Markdown と Markdown Preview Enhanced での数式記法の違い

GitLab Flavoured Markdown の記法

- <code>$``$</code> (<code>$\`</code> と <code>\`$</code> の間に [KaTeX](https://katex.org/) の記法で書く)
- <code>```math</code> で始まるコードブロック

[Markdown Preview Enhanced の記法](https://shd101wyy.github.io/markdown-preview-enhanced/#/math)

- インライン記法
  - <code>$...$</code>
  - <code>\\(...\\)</code>
- ブロック記法
  - <code>$$...$$</code>
  - <code>\\[...\\]</code>
  - <code>```math</code> で始まるコードブロック

<code>```math</code> で始まるコードブロックは GitLab Flavoured Markdown でも対応していますが、その他は対応してません。

## Markdown Preview Enhanced の記法に対応したコミット

[KaTeX syntax adapted to MPE · yasumichi/gitbucket-markdown-enhanced@623d786](https://github.com/yasumichi/gitbucket-markdown-enhanced/commit/623d78699e80526bafba6e9d22b9d6706fae51c1)

別記事に書いていますが、このコードには問題があったため、最終的なコードとは異なっていることをご了承ください。

## AST 用ノードの作成

[src/main/scala/io/github/yasumichi/gme/InlineKaTeX.scala](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/623d78699e80526bafba6e9d22b9d6706fae51c1/src/main/scala/io/github/yasumichi/gme/InlineKaTeX.scala) で AST[^AST] 用のノードを作成しました。

[^AST]: AST :  Abstract Syntax Tree 、日本語では[抽象構文木](https://ja.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E6%A7%8B%E6%96%87%E6%9C%A8)と訳される。

```scala:src/main/scala/io/github/yasumichi/gme/InlineKaTeX.scala
package io.github.yasumichi.gme

import com.vladsch.flexmark.util.ast.Node
import com.vladsch.flexmark.util.sequence.BasedSequence

/**
  * InlineKatex class
  *
  * AST node that holds the inline KaTeX syntax of flexmark-java.
  * 
  * `$...$` is represented as InlineKatex node.
  * An instance is created by the InlineKatexInlineParserExtension class.
  *
  * @param text
  * @param source
  */
class InlineKatex(val text: BasedSequence, val source: BasedSequence) extends Node {
  override def getSegments: Array[BasedSequence] = Array(source)
}
```

## インラインパーサーの作成

次に上で作成したノードに格納する部分を担うインラインパーサーを作成しました。

[src/main/scala/io/github/yasumichi/gme/InlineKatexInlineParserExtension.scala](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/623d78699e80526bafba6e9d22b9d6706fae51c1/src/main/scala/io/github/yasumichi/gme/InlineKatexInlineParserExtension.scala)

```scala:src/main/scala/io/github/yasumichi/gme/InlineKatexInlineParserExtension.scala
package io.github.yasumichi.gme

import com.vladsch.flexmark.util.ast.Node
import com.vladsch.flexmark.util.sequence.BasedSequence
import com.vladsch.flexmark.parser.{
  InlineParser,
  InlineParserExtension,
  InlineParserExtensionFactory,
  LightInlineParser
}

import org.slf4j.LoggerFactory

/**
  * InlineKatexInlineParserExtension class
  * 
  * Inline parser extension that parses the inline KaTeX syntax.
  * 
  * It recognizes the following patterns:
  * - `\[...\]` 
  * - `$$...$$`
  * - `$...$`
  * - `\(...\)`
  */
class InlineKatexInlineParserExtension extends InlineParserExtension {
  private val logger = LoggerFactory.getLogger(classOf[InlineKatexInlineParserExtension])

  override def finalizeDocument(inlineParser: InlineParser): Unit = {}

  override def finalizeBlock(inlineParser: InlineParser): Unit = {}

  override def parse(inlineParser: LightInlineParser): Boolean = {
   val patterns = List("""\\\[(.+?)\\\]""", """\$\$(.+?)\$\$""", """\$(.+?)\$""", """\\\((.+?)\\\)""")
    logger.debug("Input: " + inlineParser.getInput().toString())

    for (patternText <- patterns) {
      logger.debug(s"Trying pattern: $patternText")
      val matches = inlineParser.matchWithGroups(java.util.regex.Pattern.compile(patternText))
      if (matches != null) {
        logger.debug(s"Matched pattern: $patternText with content: ${matches(1)}")
        inlineParser.flushTextNode()
        val katexText = matches(1)
        inlineParser.getBlock.appendChild(new InlineKatex(katexText, matches(0)))
        return true
      }
    }
    false
  }
}

object InlineKatexInlineParserExtension {
  class Factory() extends InlineParserExtensionFactory {
    override def getCharacters: CharSequence = "$\\"
    override def apply(inlineParser: LightInlineParser): InlineParserExtension = new InlineKatexInlineParserExtension()
    override def getAfterDependents: java.util.Set[Class[_]] = null
    override def getBeforeDependents: java.util.Set[Class[_]] = null
    override def affectsGlobalScope(): Boolean = false
  }
}
```

## インラインパーサーを拡張機能に組み込む

上記で作成したインラインパーサーを拡張機能に組み込みます。関連部分のみ抜粋します。

[src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedExtention.scala](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/623d78699e80526bafba6e9d22b9d6706fae51c1/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedExtention.scala)

```scala:src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedExtention.scala
class MarkdownEnhancedExtention extends ParserExtension with HtmlRendererExtension {

  /**
  * Extend the parser with custom inline parser extension
  *
  * @param parserBuilder The parser builder to extend
  */
  override def extend(parserBuilder: Parser.Builder): Unit = {
    parserBuilder.customInlineParserExtensionFactory(new MarkInlineParserExtension.Factory())
    parserBuilder.customInlineParserExtensionFactory(new InlineUriInlineParserExtension.Factory())
    parserBuilder.customInlineParserExtensionFactory(new InlineKatexInlineParserExtension.Factory())  // ここを追加
  }
```

## InlineKatex ノードを HTML に変換する部分

InlineKatex ノードを HTML に変換する部分を実装します。

[src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedNodeRenderer.scala](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/623d78699e80526bafba6e9d22b9d6706fae51c1/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedNodeRenderer.scala)

まず、既存の MarkdownEnhancedNodeRenderer で InlineKatex ノードを処理する意思表示と処理するメソッドを登録します。

```scala:src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedNodeRenderer.scala
  override def getNodeRenderingHandlers(): util.Set[NodeRenderingHandler[_ <: Object]] = {
(中略)
    set.add(
      new NodeRenderingHandler[InlineKatex](
        classOf[InlineKatex],
        this.renderInlineKatex
      )
    )
```

実際の処理を行う renderInlineKatex メソッドを実装します。

```scala:src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedNodeRenderer.scala
  private def renderInlineKatex(
      node: InlineKatex,
      context: NodeRendererContext,
      html: HtmlWriter
  ): Unit = {
    if (node.source.startsWith("$$") || node.source.startsWith("\\[")) {
      // Display math
      html
        .withAttr()
        .attr("class", "katex")
        .tag("div")
      html.text(node.text.toString())
      html.tag("/div")
    } else {
      // Inline math
      html
        .withAttr()
        .attr("class", "katex")
        .tag("span")
      html.text(node.text.toString())
      html.tag("/span")
    }
  }
```

## 参考リンク

- [新Markdown導入の背景とその実装について | 株式会社ヌーラボ(Nulab inc.)](https://nulab.com/ja/blog/nulab/new-markdown-implementation-background/#flexmark-java%E3%81%A7Markdown%E3%83%91%E3%83%BC%E3%82%B5%E3%83%BC%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B)
- [Math Typesetting](https://shd101wyy.github.io/markdown-preview-enhanced/#/math) Markdown Preview Enhanced のマニュアル
- [抽象構文木 - Wikipedia](https://ja.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E6%A7%8B%E6%96%87%E6%9C%A8)
- [構文解析 - 抽象構文木(AST)を理解する｜Goで作る静的解析ツール開発入門](https://zenn.dev/hsaki/books/golang-static-analysis/viewer/syntax-analysis-ast)
- [たった1行から始めるPythonのAST(抽象構文木)入門 #Python - Qiita](https://qiita.com/rhoboro/items/5bbaa3fa659ed7454d56)
- [ast --- Abstract syntax trees — Python 3.14.2 ドキュメント](https://docs.python.org/ja/3.14/library/ast.html)
- [「コンパイラ実習」2025 年度課題 © 関西学院大学](https://ist.ksc.kwansei.ac.jp/~ishiura/xcpl/note/ast.pdf)
