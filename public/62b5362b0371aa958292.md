---
title: GitBucket の Ace エディターで vim キーバインドなどが使えるようにして Wiki でも利用できるよう改造した件
tags:
  - HTML
  - JavaScript
  - Scala
  - GitBucket
private: false
updated_at: '2026-01-21T21:24:52+09:00'
id: 62b5362b0371aa958292
organization_url_name: null
slide: false
ignorePublish: false
---
## 概要(背景)

[GitBucket](https://gitbucket.github.io/)用のプラグイン [GitBucket Markdown Enhanced Plugin](https://github.com/yasumichi/gitbucket-markdown-enhanced)を開発しています。

GitBucket Markdown Enhanced Plugin は、GitBucket 標準のマークダウンレンダリングエンジンを置き換えるプラグインです。

目標は、[Visual Studio Code](https://code.visualstudio.com/) の [Markdown Preview Enhanced](https://shd101wyy.github.io/markdown-preview-enhanced/#/) 向けの markdown ファイルを軽易に Web で共有できる環境です。

プラグインの性質上、テストをする際に GitBucket 上で編集を行うことが多くなります。

普段、Visual Studio Code を [Vim](https://www.vim.org/) キーバインドで使用しているライトな Vimmer ですが、ブラウザに切り替えた時に Vim キーバインドが使えないのは、結構なストレスです。

GitBucket において、リポジトリのファイル編集を行うのに使用されているエディター部品は、[Ace](https://ace.c9.io/)(Ajax.org Cloud9 Editor)です。

幸い、過去に開発していた [SeaPig](https://github.com/yasumichi/seapig) というマークダウンエディターで Ace を使用していたため、軽易に Vim や Emacs のキーバインドに変更できるのを知っていました。

当初は、GitBucket 本体を改造しても受理してもらえるか分からないし、成果を届けるのに時間がかかると思い、[GitBucket Ace Mode Selector](https://github.com/yasumichi/gitbucket-ace-mode-selector) というプラグインを開発しました。

そのテストの中で Wiki の編集画面を見た時に単なる `<textarea>` であることに違和感を覚えました。

リポジトリのファイル編集は、原則ローカルで編集して Push という運用が自然かと思います。

Wiki も Git リポジトリとしてローカルにクローンできますが、その性質上、Web 上で軽易に編集できるのが望ましいのではないでしょうか。

むしろリポジトリのファイル編集よりも、Ace のようなリッチなエディター部品が使えた方が良いのではないかと考え、GitBucket を改造しプルリクエストを発行しました。

- [Fixed so that Ace Editor can be used when editing Wiki. by yasumichi · Pull Request #3925 · gitbucket/gitbucket](https://github.com/gitbucket/gitbucket/pull/3925)

概要が長くなってしまった…

:::note info
プルリクエストは、無事にマージされました。
:::

## GitBucket Ace Mode Selector の開発

次のスクリーンショットは、通常のファイル編集時の画面です。

![](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/a19d551d-4a0a-4076-b5fd-b839c5dc6dd1.png)

エディター右上には、テーマとテキストの折り返しを制御するドロップダウンリストのみが存在します。

![](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/ad10134d-2a55-438b-91cf-ca5f3dec7d7c.png)

この左側辺りにキーバインドを変更できるドロップダウンリストを表示し、Default/Emacs/Vim からキーバインドを選択できるようにしたいと考えました。

プラグインをインストールすると以下のようにキーバインドを選択できるようになります。

![](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/02e2a149-b309-4a01-9da7-a7e0ed78b0f4.png)

当初は、他のスクリプトで生成された Ace への参照を取得できるか心配でしたが、Ace を構築する際と同じ [ace.edit()](https://ajaxorg.github.io/ace-api-docs/functions/src_ace.edit.html) でエディターへの参照を取得できることが分かりました。

[src/main/resources/gams/assets/gams.js](https://github.com/yasumichi/gitbucket-ace-mode-selector/blob/3235674d6d0df5ced9cafb881495b1ca8139664f/src/main/resources/gams/assets/gams.js#L43)

```javascript:src/main/resources/gams/assets/gams.js
const editor = ace.edit(editorTag);
```

ただし、本家よりも先に実行されると Firefox では、下図のように改行がなくなる問題が起きました。(Google Crome では再現できず。)

![](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/64f14ced-37a6-4f5d-bdcb-52f23d018fcc.png)

仕方がないので setInterval() で 100ms ごとに Ace が生成するタグが取得できるか確認し、取得出来たら、処理を始めるようにしました。

```javascript:src/main/resources/gams/assets/gams.js
        var waitAce = setInterval(() => {
            var aceGutter = document.querySelector('.ace_gutter');
            if (aceGutter != null) {
                clearInterval(waitAce);
                const editor = ace.edit(editorTag);
                var aceKeyMode = localStorage.getItem("aceKeyMode") || "";
                select.value = aceKeyMode;
                editor.setKeyboardHandler(aceKeyMode == "" ? null : aceKeyMode);
                select.addEventListener('change', () => {
                    editor.setKeyboardHandler(select.value == "" ? null : select.value);
                    localStorage.setItem("aceKeyMode", select.value);
                },true)
            }
        }, 100)
```

キーバインドの変更を行うのは、[editor.Editor.setKeyboardHandler()](https://ajaxorg.github.io/ace-api-docs/classes/src_editor.Editor.html#setKeyboardHandler) です。

毎回、切替を行うのは煩わしいので [localStrorage](https://developer.mozilla.org/ja/docs/Web/API/Window/localStorage) で設定を記憶し、次に開いたときに読み込むようにしています。

## GitBucket 本体の修正

Wiki でも Ace を使用したく、GitBucket 本体の修正をしました。リポジトリのファイルエディターと共通化できる部分を考え、ナビゲーションバーの部分を別の [Twirl](https://github.com/playframework/twirl) テンプレートに切り出しました。

- [src/main/twirl/gitbucket/core/helper/acenavbar.scala.html](https://github.com/gitbucket/gitbucket/pull/3925/files#diff-dd029c5f07915c900626606b0beaaf1721c59143473765a20e543a227236c173) を新規に作成しました。

リポジトリのファイルエディター側でこのテンプレートを使うように修正しました。

- [src/main/twirl/gitbucket/core/repo/editor.scala.html](https://github.com/gitbucket/gitbucket/pull/3925/files#diff-3d304e0594a82e366f2ba4dd074015cc276c2032e7cc5699d03a955b19a0fc9d)

先ほどの acenavbar.scala.html を取り込むのが、31行目の次のコードです。

```scala:src/main/twirl/gitbucket/core/repo/editor.scala.html
@gitbucket.core.helper.html.acenavbar()
```

合わせてキーバインドを変更するコードを加えています。

```javascript:src/main/twirl/gitbucket/core/repo/editor.scala.html
  var aceKeyboard = localStorage.getItem("gitbucket:editor:keyboard") || "";
  editor.setKeyboardHandler(aceKeyboard == "" ? null : aceKeyboard);

  var aceKeyboardSelect = document.getElementById("aceKeyboardSelect");
  aceKeyboardSelect.value = aceKeyboard;

  aceKeyboardSelect.addEventListener('change', () => {
      editor.setKeyboardHandler(aceKeyboardSelect.value == "" ? null : aceKeyboardSelect.value);
      localStorage.setItem("gitbucket:editor:keyboard", aceKeyboardSelect.value);
  },true)
```

GitBucket Ace Mode Selector との違いは、次の3点です。

- setInterval() が不要になった。
- localStorage で保存する項目名を GitBucket 側の命名規則に合わせた。(`aceKeyMode`→`gitbucket:editor:keyboard`)
- その他、DOM 要素の id 修正とそれに伴う変数名の修正

Wiki 側のエディターを修正するために次のファイルを修正しています。

- [src/main/twirl/gitbucket/core/wiki/edit.scala.html](https://github.com/gitbucket/gitbucket/pull/3925/files#diff-5b69d52545af78cf19fa1148bd4845fdc0b1634f0a4a4f160cb123a78073f221)

主な修正点は、以下のとおりです。

- acenavbar.scala.html を取り込み
- issue などと共有していたエディター・プレビューへの依存を削除
- リポジトリのファイルエディターと同じ、エディター・プレビュー用要素の追加
- Ace を制御する JavaScript の追加(リポジトリのファイルエディターと共通化できそうだが、後述する検討が必要で見送り。)
- 添付ファイルのドラッグ&ドロップを制御している部分を Ace 向けに修正

最後の項目について、添付ファイルのアップロードに成功した場合に実行されるリンクの挿入部分を以下のように修正しました。

```javascript:src/main/twirl/gitbucket/core/wiki/edit.scala.html(修正前)
$('#content1').val($('#content1').val() + attachFile);
```

↓

```javascript:src/main/twirl/gitbucket/core/wiki/edit.scala.html(修正後)
editor.session.insert(editor.selection.getCursor(), attachFile);
```

副次的効果として、これまでは必ず末尾に追加されていましたが、今回の修正によりカーソル位置に挿入されるようになりました。

### JavaScript 共通化の検討

- Scala のコードにより、JavaScript が生成されている部分があるのでその部分は外部 JavaScript にできない。
- 各機能で固有の部分の切り分け

## 次はマークダウンの入力支援ツールバーが欲しくなるよね?

Vimmer には不要かもしれないけど。

昨日、[Issues](https://github.com/gitbucket/gitbucket/issues) を検索したら、2017年にたけぞうさんの提案があったり、2020年にプルリクエストもあったみたいですが、止まっているようです。

- [Add toolbar and help to Markdown editor · Issue #1793 · gitbucket/gitbucket](https://github.com/gitbucket/gitbucket/issues/1793)
- [Any reason, why markdown editor is absent? · Issue #1906 · gitbucket/gitbucket](https://github.com/gitbucket/gitbucket/issues/1906)
- [Add markdown toolbar by onukura · Pull Request #2517 · gitbucket/gitbucket](https://github.com/gitbucket/gitbucket/pull/2517)
- [Add markdown toolbar by onukura · Pull Request #2528 · gitbucket/gitbucket](https://github.com/gitbucket/gitbucket/pull/2528)

経緯が理解でき、後押しがあったら、挑戦するかも。
