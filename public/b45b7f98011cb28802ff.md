---
title: GitBucket Markdown Enhanced Plugin で目次を右側に固定配置するように修正しました
tags:
  - JavaScript
  - Scala
  - Markdown
  - GitBucket
private: false
updated_at: '2026-01-01T15:31:07+09:00'
id: b45b7f98011cb28802ff
organization_url_name: null
slide: false
ignorePublish: false
---
## 概要

[GitBucket](https://gitbucket.github.io/)用のプラグイン [GitBucket Markdown Enhanced Plugin](https://github.com/yasumichi/gitbucket-markdown-enhanced)を開発しています。

GitBucket Markdown Enhanced Plugin は、GitBucket 標準のマークダウンレンダリングエンジンを置き換えるプラグインです。

目標は、[Visual Studio Code](https://code.visualstudio.com/) の [Markdown Preview Enhanced](https://shd101wyy.github.io/markdown-preview-enhanced/#/) 向けの markdown ファイルを軽易に Web で共有できる環境です。

これまで `[TOC]` という記法で生成した目次は、本文内に配置されていましたが、右側に独立させて固定配置するように修正し、バージョン [0.6.2](https://github.com/yasumichi/gitbucket-markdown-enhanced/releases/tag/v0.6.2) としてリリースしました。

:::note warn
issues や Pull Requests で使用した場合は、これまでどおり、本文に配置されます。
（必要ないですよね？）
また、複数箇所に [TOC] を記述した場合は、最初の目次のみ、右側に配置します。
:::

## 前回の記事

https://qiita.com/yasumichi/items/fe740aeeeafd1e25a2a7

## Before After

これまで `[TOC]` という記法で生成した目次は、次の画像のように本文内に配置されていました。

![before.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/91ba4d99-4a82-4642-812e-f265233755c4.png)

今後は、次の画像のように本文の右側に固定配置されるようになります。

![after.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/67086ca4-8284-4af3-8748-38732622aec7.png)

なお、ファイルリストが表示されている時など邪魔にならないようスクロール時に縦位置を調整するようにしています。

![before_scroll.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/4cfb6832-432f-453b-9ade-84fbb5192365.png)

↓

![after_scroll.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/9ccd1dd5-f3dd-4243-a230-fca9f6b2d4e5.png)

また、右上の `Table of Contents` というタイトルをクリックすると目次を折りたためます。

![close_details.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/36738/d2c5e836-7ed3-4ce4-bfda-2ecaeddaaca6.png)

以下、ソースの修正について、解説します。

## TocExtension の設定を変更し目次にクラスを付与

[flexmark-java](https://github.com/vsch/flexmark-java/) の [Table of Contents Extension](https://github.com/vsch/flexmark-java/wiki/Table-of-Contents-Extension)(TocExtension) の `LIST_CLASS` オプションを設定し、目次が格納される [&lt;ul&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/ul) タグにクラスを付与しました。

[src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedRenderer.scala](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/3588a320e8de78f3c2e07058a9a7cf984bb1a713/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedRenderer.scala#L87) に以下の行を追加しています。

```scala:src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedRenderer.scala
    options.set(TocExtension.LIST_CLASS, "toc")
```

## 目次のスタイル変更を行う JavaScript 関数の追加

[src/main/resources/gme/assets/gme.js](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/3588a320e8de78f3c2e07058a9a7cf984bb1a713/src/main/resources/gme/assets/gme.js#L14) に以下の関数を追加しました。

```javascript:src/main/resources/gme/assets/gme.js
    var updateTocStyle = function() {
        const toc = document.querySelector('.toc');
        if (toc) {
            const parent = toc.parentElement;
            const details = document.createElement('details');
            const summary = document.createElement('summary')
            if (!document.location.toString().includes("/wiki/")) {
                toc.style.height = `${document.documentElement.clientHeight * 0.7}px`
                toc.style.overflowY = "scroll";
            }
            details.classList.add("toc-wrapper");
            details.open = true;
            summary.textContent = "Table of contents"
            summary.classList.add("toc-summary");
            parent.insertBefore(details, toc);
            details.appendChild(summary);
            details.appendChild(toc);
            var parentY = parent.getClientRects()[0].y;
            details.style.position = "fixed";
            if (document.location.toString().includes("/wiki/")) {
                details.style.right = "270px";
            } else {
                details.style.right = "20px";
            }
            if (parentY > 0) {
                details.style.top = `${Math.floor(parentY)+2}px`;
            } else {
                details.style.top = "0px";
            }
            document.addEventListener("scrollend", (event) => {
                var parentY = parent.getClientRects()[0].y;
                if (parentY > 0) {
                    details.style.top = `${Math.floor(parentY)+2}px`;
                } else {
                    details.style.top = "0px";
                }
            });
        }
    }
```

順番に説明していきます。

```javascript:src/main/resources/gme/assets/gme.js
        const toc = document.querySelector('.toc');
        if (toc) {
          // 中略
        }
```

[class](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Global_attributes/class) 属性が、`toc` に設定されているノードを取得します。

取得できた場合、[if](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Statements/if...else) ブロック内を実行します。

```javascript:src/main/resources/gme/assets/gme.js
            const parent = toc.parentElement;
            const details = document.createElement('details');
            const summary = document.createElement('summary')
```

- `toc` の親ノードを `parent` に格納
- 新たに [&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグを作成し、 `details` に格納
- 新たに [&lt;summary&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/summary) タグを作成し、 `summary` に格納

```javascript:src/main/resources/gme/assets/gme.js
            if (!document.location.toString().includes("/wiki/")) {
                toc.style.height = `${document.documentElement.clientHeight * 0.7}px`
                toc.style.overflowY = "scroll";
            }
```

wiki でないことを確認し、以下の処理を行います。

- toc の高さを [document](https://developer.mozilla.org/ja/docs/Web/API/Window/document).[documentElement](https://developer.mozilla.org/ja/docs/Web/API/Document/documentElement).[clientHeight](https://developer.mozilla.org/ja/docs/Web/API/Element/clientHeight) の 70% に指定します。
- 上記高さに入らない項目がある場合、スクロールして表示できるよう [overflow-y](https://developer.mozilla.org/ja/docs/Web/CSS/Reference/Properties/overflow-y) を `scroll` に設定

```javascript:src/main/resources/gme/assets/gme.js
            details.classList.add("toc-wrapper");
            details.open = true;
            summary.textContent = "Table of contents"
            summary.classList.add("toc-summary");
            parent.insertBefore(details, toc);
            details.appendChild(summary);
            details.appendChild(toc);
```

以下の処理をしています。

- [&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグの [class](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Global_attributes/class) 属性に `toc-wrapper` を追加
- [&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグの [open](https://developer.mozilla.org/ja/docs/Web/API/HTMLDetailsElement/open) 属性を true に設定(開いておく)
- [&lt;summary&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/summary) タグの [textContent](https://developer.mozilla.org/ja/docs/Web/API/Node/textContent) を `Table of contents` に設定
- [&lt;summary&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/summary) タグの [class](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Global_attributes/class) 属性に `toc-summary` を追加
- 目次の親要素 parent の目次の前に [&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) を挿入
- [&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグの子として [&lt;summary&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/summary) タグを追加
- [&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグの子として目次を追加

```javascript:src/main/resources/gme/assets/gme.js
            var parentY = parent.getClientRects()[0].y;
            details.style.position = "fixed";
            if (document.location.toString().includes("/wiki/")) {
                details.style.right = "270px";
            } else {
                details.style.right = "20px";
            }
            if (parentY > 0) {
                details.style.top = `${Math.floor(parentY)+2}px`;
            } else {
                details.style.top = "0px";
            }
```

- 目次の元親要素の縦位置を取得
- [&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグの [position](https://developer.mozilla.org/ja/docs/Web/CSS/Reference/Properties/position) を `fixed` に
設定
- wiki かどうかにより分岐
  - wiki の場合、[&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグの [right](https://developer.mozilla.org/ja/docs/Web/CSS/Reference/Properties/right) を `270px` に設定(カスタムサイドバーとの干渉を回避)
  - wiki でない場合、[&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグの [right](https://developer.mozilla.org/ja/docs/Web/CSS/Reference/Properties/right) を `20px` に設定
- 目次の元親要素の縦位置が 0 より大きいかで分岐
  - 0 より大きい場合、親要素の縦位置から計算し、[&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグの [top](https://developer.mozilla.org/ja/docs/Web/CSS/Reference/Properties/top) を計算
  - 0 以下の場合は、[&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグの [top](https://developer.mozilla.org/ja/docs/Web/CSS/Reference/Properties/top) を 0 に設定


```javascript:src/main/resources/gme/assets/gme.js
            document.addEventListener("scrollend", (event) => {
                var parentY = parent.getClientRects()[0].y;
                if (parentY > 0) {
                    details.style.top = `${Math.floor(parentY)+2}px`;
                } else {
                    details.style.top = "0px";
                }
            });
```

[document](https://developer.mozilla.org/ja/docs/Web/API/Window/document) の [scrollend](https://developer.mozilla.org/ja/docs/Web/API/Document/scrollend_event) イベントで目次の元親要素の縦位置から、[&lt;details&gt;](https://developer.mozilla.org/ja/docs/Web/HTML/Reference/Elements/details) タグの [top](https://developer.mozilla.org/ja/docs/Web/CSS/Reference/Properties/top) を変更します。
