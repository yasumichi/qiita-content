---
title: GitBucket Markdown Enhanced Plugin 独自のインライン記法を表に入れると例外が発生し描画ができない問題を解消しました
tags:
  - Scala
  - Markdown
  - GitBucket
  - KaTeX
private: false
updated_at: '2025-12-27T13:08:00+09:00'
id: a24742d5a129732fb0ea
organization_url_name: null
slide: false
ignorePublish: false
---
## 概要

[GitBucket](https://gitbucket.github.io/)用のプラグイン [GitBucket Markdown Enhanced Plugin](https://github.com/yasumichi/gitbucket-markdown-enhanced)を開発しています。

GitBucket Markdown Enhanced Plugin は、GitBucket 標準のマークダウンレンダリングエンジンを置き換えるプラグインです。

目標は、[Visual Studio Code](https://code.visualstudio.com/) の [Markdown Preview Enhanced](https://shd101wyy.github.io/markdown-preview-enhanced/#/) 向けの markdown ファイルを軽易に Web で共有できる環境です。

今まで以下のインライン要素を独自で追加してきました。

- [Mark](https://zenn.dev/yasumichi/articles/7d0b42a9858912)(`==Marked==` と書くと `<mark>Marked</mark>` に変換されます。)
- [URLの自動リンク](https://qiita.com/yasumichi/items/d4b0cf525470a98e86dc)
- [Markdown Preview Enhanced 互換の数式](https://qiita.com/yasumichi/items/c270c701ed270f622a76)

ところが、数式の記法について職場向けに説明を作っている際に表に埋め込むと例外が発生して描画に失敗する事象に気づいたので対処した話です。

## 前回の記事

https://qiita.com/yasumichi/items/c270c701ed270f622a76

## 表に独自のインライン要素を入れる例外が発生し描画に失敗していた

[KaTeX](https://katex.org/) による数式を表に埋め込むと以下の例外が発生してページ全体の表示ができない問題に気づきました。

```
java.lang.StringIndexOutOfBoundsException: endIndex: 321 out of range: [0, 0]
```

この際、[flexmark-java](https://github.com/vsch/flexmark-java) の [GitLab Flavoured Markdown](https://github.com/vsch/flexmark-java/wiki/Extensions#gitlab-flavoured-markdown) という拡張機能による記法では、同事象は発生しませんでした。

## GitLab Flavoured Markdown での処理を調査してみる

GitLab Flavoured Markdown における 数式用の AST[^AST] 用ノードは、[flexmark-ext-gitlab/src/main/java/com/vladsch/flexmark/ext/gitlab/GitLabInlineMath.java](https://github.com/vsch/flexmark-java/blob/bcfe84a3ab6d23d04adce3e5a0bae45c6b791d14/flexmark-ext-gitlab/src/main/java/com/vladsch/flexmark/ext/gitlab/GitLabInlineMath.java) で定義されていました。

```java:flexmark-ext-gitlab/src/main/java/com/vladsch/flexmark/ext/gitlab/GitLabInlineMath.java
public class GitLabInlineMath extends Node implements DelimitedNode {
```
[src/main/scala/io/github/yasumichi/gme/InlineKaTeX.scala](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/623d78699e80526bafba6e9d22b9d6706fae51c1/src/main/scala/io/github/yasumichi/gme/InlineKaTeX.scala) との違いは、[com.vladsch.flexmark.util.ast.Node](https://github.com/vsch/flexmark-java/blob/bcfe84a3ab6d23d04adce3e5a0bae45c6b791d14/flexmark-util-ast/src/main/java/com/vladsch/flexmark/util/ast/Node.java) クラスを継承するだけではなく、[com.vladsch.flexmark.util.ast.DelimitedNode](https://github.com/vsch/flexmark-java/blob/bcfe84a3ab6d23d04adce3e5a0bae45c6b791d14/flexmark-util-ast/src/main/java/com/vladsch/flexmark/util/ast/DelimitedNode.java) インターフェースを同時に継承していることです。

同様の方法に実装を修正すれば、問題に対処できるのではないか思い、インラインパーサーの処理を確認してみることにしました。

GitLab Flavoured Markdown における 数式用のインラインパーサーは、[flexmark-ext-gitlab/src/main/java/com/vladsch/flexmark/ext/gitlab/internal/GitLabInlineMathParser.java](https://github.com/vsch/flexmark-java/blob/bcfe84a3ab6d23d04adce3e5a0bae45c6b791d14/flexmark-ext-gitlab/src/main/java/com/vladsch/flexmark/ext/gitlab/internal/GitLabInlineMathParser.java)で定義されていました。

[^AST]: AST :  Abstract Syntax Tree 、日本語では[抽象構文木](https://ja.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E6%A7%8B%E6%96%87%E6%9C%A8)と訳される。

## 対処を行ったコミット

調査を元に対処を行ったのが以下3つのコミットです。(数式、マーク、自動リンクの順)

- [Fixed a bug that caused an exception when writing a formula in a table. · yasumichi/gitbucket-markdown-enhanced@bd3f62a](https://github.com/yasumichi/gitbucket-markdown-enhanced/commit/bd3f62a4a4f86cdaa74eeecbef065539d625eca4)
- [Fixed a bug that caused an exception when writing a mark in a table. · yasumichi/gitbucket-markdown-enhanced@6ea3b56](https://github.com/yasumichi/gitbucket-markdown-enhanced/commit/6ea3b56b2f7bffae92aa38dbf9de18820def9d0f)
- [Fixed a bug that caused an exception when writing a URI in a table · yasumichi/gitbucket-markdown-enhanced@0bca60a](https://github.com/yasumichi/gitbucket-markdown-enhanced/commit/0bca60a510c556c581cedfc9ad9a32977e4c3e49)

数式とマークは、[com.vladsch.flexmark.util.ast.DelimitedNode](https://github.com/vsch/flexmark-java/blob/bcfe84a3ab6d23d04adce3e5a0bae45c6b791d14/flexmark-util-ast/src/main/java/com/vladsch/flexmark/util/ast/DelimitedNode.java) インターフェースを継承しました。

自動リンクは、対象部分を囲む書式がないので [com.vladsch.flexmark.util.ast](https://github.com/vsch/flexmark-java/blob/bcfe84a3ab6d23d04adce3e5a0bae45c6b791d14/flexmark-util-ast/src/main/java/com/vladsch/flexmark/util/ast/DoNotDecorate.java) インターフェースを継承するようにしました。

以上で表に埋め込んでも例外が発生しないようになりました。

## 参考リンク

- [新Markdown導入の背景とその実装について | 株式会社ヌーラボ(Nulab inc.)](https://nulab.com/ja/blog/nulab/new-markdown-implementation-background/#flexmark-java%E3%81%A7Markdown%E3%83%91%E3%83%BC%E3%82%B5%E3%83%BC%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B)
